- [[22_Code_Sql]]
   **自己寫的[case]20211217_User Story 29927 【Data】SalesForce：Helpdesk历史数据搬迁
  EXEC(@sqlscript1)
  SQL中@variable無法判斷帶入1~n個變數，若要在類似Function中帶入1~n個變數，需寫成EXEC寫法**
  
  ```
  DECLARE @issueid NVARCHAR(100), @sqlscript1 NVARCHAR(Max), @sqlscript2 NVARCHAR(Max), @sqlscript3 NVARCHAR(Max), @sqlscript4 NVARCHAR(Max)
  SET @issueid = '''1234'',''1235'',''1235'',''56905'',''56165'''
  SET @sqlscript1 = 
  	'SELECT IssueID, Detail
  	FROM tcithelpdesk.[dbo].[Issue] WITH(NOLOCK)
  	WHERE issueid IN ('+@issueid+')
  	ORDER BY issueid'
  EXEC(@sqlscript1)
  ```
-
- [[22_Code_Sql]]
   **自己寫的【JD系列公司】结汇名单统整_EricH优化_20220607
  IF判斷(NOT EXISTS, SELECT Count(*)=n)判斷SQL邏輯
  只有上方IF的幾個條件達成，才會進去執行BEGIN到END的邏輯**
  
  ```
  IF NOT EXISTS (
    	SELECT *
    	FROM [TCITEAP].[ESOPBasicInfo].[SettlementRegistrationConfig]
    	WHERE [CompanyID] IN (140, 258, 264, 202)
    	AND STATUS <> 3
            	  )
  AND(
  	SELECT COUNT(*) FROM
          (
          SELECT * 
          from TCITClient.CompanyInfo.CompanyMoneyAccount
          where companyid = 140
          and status = 2 --有效 
          and MoneyOperationTypeID = 4--账户余额
          and INOnlineBusinessName IS NULL --员工
          and TransactionTypeID = 2
          ) CMA1
     ) = 1
    BEGIN
        PRINT('統計結果')
    END
  ELSE
    BEGIN
        PRINT('LINE75行以前配置检查有错误，幣種選擇或CompanyMoneyAccount配置有问题，请检查[TCITEAP].[ESOPBasicInfo].[SettlementRegistrationConfig]或TCITClient.CompanyInfo.CompanyMoneyAccount')
    END
  ```
-
- [[22_Code_Sql]]
   **自己寫的双层while回圈**
  
  ```
  DECLARE @C1 INT = 0, @C2 INT = 0, @C3 INT = 0
  WHILE @C3 < 2
  	BEGIN
  	SET @C3 = @C3 + 1
  	WHILE @C1 < 3
  		-->><<>><<
  		BEGIN
  		SET @C1 = @C1 + 1
  
  		WHILE @C2 < 5
  			--<<<<<
  			BEGIN
  			SET @C2 = @C2 + 1
  			SELECT(@c1)
  			SELECT(@c2)
  			SELECT(@C3)
  			SELECT('----运行脚本')
  			END
  			--<<<<<
  		SET @C2 = 0
  		END
  		-->><<>><<
  	SET @C1 = 0
  	END
  ```
-
- [[22_Code_Sql]]
   **自己寫的月份补零的写法，基本就是字串分割跟判斷月份是否為雙位數補零**
  
  ```
  -- 西元年轉成民國年
       (CONVERT(nvarchar, YEAR(sd_birthday)-1911)  + 
  -- 月份 不足長度補0
        replicate('0', (2-len(MONTH(sd_birthday)))) +
       CONVERT(nvarchar, MONTH(sd_birthday)) + 
  -- 日期 不足長度補0
       replicate('0', (2-len(DAY(sd_birthday)))) +
       CONVERT(nvarchar,DAY(sd_birthday))) AS birthday
  
  
  核聚实际操作，月份补零
  
  DECLARE @transactionDate VARCHAR(10), @mailDeliverDate VARCHAR(10)
  SET @mailDeliverDate = '2022-02-07'      --需求信件里面会给
  set @transactionDate = CASE WHEN SUBSTRING(@mailDeliverDate,6,2) = '01' 
  							THEN  CONVERT(VARCHAR,SUBSTRING(@mailDeliverDate,1,4)-1) + '-12-01'
  					   ELSE CONVERT(VARCHAR,SUBSTRING(@mailDeliverDate,1,4))+'-'+ REPLICATE('0', (2-LEN(MONTH(@maildeliverdate)-1))) + CONVERT(NVARCHAR, MONTH(@maildeliverdate)-1) +'-01'
  					   END
  --print @transactiondate
  --SET @transactionDate = '2022-01-01'	 
  --基本上是需求信件里面的上个月月初(当@mailDeliverDate = '2022-02-07', @transactionDate = '2022-01-01')
  ```
-
- [[22_Code_Sql]]
   **自己寫的月份滚上月上季的写法，基本就是月份滾算**
  
  ```
  DECLARE @Month CHAR(6), @LMonth CHAR(6), @LQuarter CHAR(6), @LYear CHAR(6), @YearCurrent CHAR(6), @EndYearCount int,  @EndYear int
  SET @Month = '202109'		 --計算股數值	 --執行腳本時輸入該期區間'202106'
  SET @LYear= CONVERT(VARCHAR,SUBSTRING(@Month,1,4)-1) + '12'      --上年末帶出'202012' ,计算当年费用
  SET @YearCurrent= CONVERT(VARCHAR,SUBSTRING(@Month,1,4)) + '12'  --当年末帶出'202112' ,计算当年费用
  SET @EndYearCount = 2
  SET @EndYear = CONVERT(varchar,YEAR(@Month+'01'))+ @EndYearCount
  
  WHILE YEAR(@Month+'01')<=@EndYear
  BEGIN
  
  --------------------------------腳本開始----
  SET @LQuarter =				 --計算股數值    --上一個季度帶出'202103' 
  	CASE WHEN RIGHT(@Month ,1) = 3 THEN CONVERT(VARCHAR,SUBSTRING(@Month,1,4)-1) + '12'
  		 WHEN RIGHT(@Month ,1) = 6 THEN CONVERT(VARCHAR,SUBSTRING(@Month,1,4)) + '03'
  		 WHEN RIGHT(@Month ,1) = 9 THEN CONVERT(VARCHAR,SUBSTRING(@Month,1,4)) + '06'
  		 WHEN RIGHT(@Month ,2) = 12 THEN CONVERT(VARCHAR,SUBSTRING(@Month,1,4)) + '09'
  	END		     
  SET @LMonth = CONVERT(VARCHAR,(CONVERT(INT,@Month-1)))			 --計算股數值    --上一个月帶出'202105' 
  
  SET @LMonth =				--若有上月资料就滚上月，没有就用上季末当上月
  	CASE WHEN (SELECT COUNT(*) FROM [TCITDataProcessTemp].dbo.t2020625ab WHERE CalculateMonth = @LMonth) = 0 THEN @Lquarter
  	ELSE @Lmonth
  	END
  
  SELECT '@Month'=@Month,'@LQuarter'=@LQuarter, '@LMonth'=@LMonth
  
  ------------------------------------------------
  IF convert(int,substring(@Month,5,2 )) =12 --如果已經到當年12月，則@Month 改成隔年1月
  	BEGIN
  		SET @Month = CONVERT(varchar,CONVERT(varchar,YEAR(@Month+'01'))+1) + '01' 
  	END
  	BEGIN --非第一次執行以季為月份
  		SET @Month= 
  			CASE WHEN CONVERT(INT,MONTH(dateadd(m,1,@Month+'01'))) BETWEEN 1 AND 3 
  			THEN CONVERT(varchar,YEAR(@Month+'01')) +'03'
  			WHEN CONVERT(INT,MONTH(dateadd(m,1,@Month+'01'))) BETWEEN 4 AND 6  
  			THEN CONVERT(varchar,YEAR(@Month+'01')) +'06'
  			WHEN CONVERT(INT,MONTH(dateadd(m,1,@Month+'01'))) BETWEEN 7 AND 9  
  			THEN CONVERT(varchar,YEAR(@Month+'01')) +'09'
  			ELSE CONVERT(varchar,YEAR(@Month+'01')) +'12'
  			END
  	END
  END
  ```
-
- [[22_Code_Sql]]
   **自己寫的回圈取得每年末的股价，每年末股價寫入一張表中包含各幣值換算**
  
  ```
  declare @date datetime
  set @date = '2006-12-31'
  WHILE year(@date) < 2022
  BEGIN
  
  insert into  [TCITDataProcessTemp].[dbo].yearendmarketprice_EH
  select c.companyid, @date LastDateofYear, year(@date) year, TCITEAP.[dbo].[F_GetPrice](@date, c.stockcode) stockprice, c.stockcode, --CIB.currencyid,
  
  CASE WHEN CIB.currencyid = 'NTD' THEN TCITEAP.[dbo].[F_GetPrice](@date, c.stockcode) * round(1/27.63200000,6) 
  	 WHEN CIB.currencyid = 'HKD' THEN TCITEAP.[dbo].[F_GetPrice](@date, c.stockcode) * 0.12824090
  	 WHEN CIB.currencyid = 'CNY' THEN TCITEAP.[dbo].[F_GetPrice](@date, c.stockcode) * round(1/ 6.379400,6)
  	 ELSE TCITEAP.[dbo].[F_GetPrice](@date, c.stockcode)  END StockPriceUSD
  from tcitclient.companyinfo.company  c
  inner join TCITEAP.ESOPBasicInfo.CompanyInfoByESOP CIB
  ON C.companyid = CIB.companyid
  where C.SpecState BETWEEN 3 AND 5
  AND C.CompanyID > 0
  AND C.CompanyName NOT LIKE N'%Demo%'
  AND C.CompanyName NOT LIKE N'%测试%'
  AND C.CompanyID <> 154
  
  SET @date = DATEADD(year, 1, @date)
  end
  
  --commit
  
  
  select * from [TCITDataProcessTemp].[dbo].yearendmarketprice_EH 
  order by companyid, year
  ```
-
- [[22_Code_Sql]]
   **RENE寫的字串分割进一张临时表_RENE，呼應另一個SQL筆記自己寫的把多个item输入後放入一个临时表_eh，反正就是將@EmployeeIDs依照特定字元切割（考量是否要去除重複字段），在八大表修改EH優化裡面也有應用此技巧**
  
  ```
  DECLARE @EmployeeIDs VARCHAR(MAX), @CompanyID INT
  
  SET @CompanyID = 7766
  SET @EmployeeIDs = 'carie;exe2626;happy;sad;carie;good'
  PRINT @EmployeeIDs
  
  SET NOCOUNT ON;
  
  	IF OBJECT_ID('tempdb..#temp_EmployeeIDs') IS NOT NULL
  		BEGIN 
  			DROP TABLE  #temp_EmployeeIDs 
  		End
  
  	CREATE TABLE #temp_EmployeeIDs 
  		(
  		 CompanyID INT 
  		,EmployeeID NVARCHAR(200) 
  		,PRIMARY KEY 
  			(
  			[CompanyID]
  			,[EmployeeID]
  			)
  		)
  		
  	INSERT INTO #temp_EmployeeIDs
  	SELECT @CompanyID AS CompanyID
  		,col AS EmployeeID
  	FROM [TCITClient].[dbo].[F_Split_2](@EmployeeIDs ,N';')
  	WHERE ISNULL(col,N'') <> N''
  
  SELECT * FROM　#temp_EmployeeIDs
  
  ------FUNCTION 写法----
  
  --USE [TCITClient]
  --GO
  
  --/****** Object:  UserDefinedFunction [dbo].[F_Split_2]  Script Date: 2022/3/24 14:45:21 ******/
  --SET ANSI_NULLS ON
  --GO
  
  --SET QUOTED_IDENTIFIER ON
  --GO
  
  --CREATE FUNCTION [dbo].[F_Split_2](@c NVARCHAR(MAX),@split VARCHAR(2)) 
  --	RETURNS @t1 TABLE(rid BIGINT, col NVARCHAR(MAX)) 
  --	AS  
  --	BEGIN 
  --		DECLARE @rid BIGINT 
  --		SET @rid=1
  --		WHILE (CHARINDEX(@split,@c) <> 0) 
  --			BEGIN
  --				DECLARE @t TABLE
  --					(
  --					rid BIGINT
  --					,col NVARCHAR(MAX)
  --					) 
  --				INSERT @t(rid, col) VALUES (@rid, SUBSTRING(@c, 1, CHARINDEX(@split, @c) - 1)) 
  --				SET @c = STUFF(@c, 1, CHARINDEX(@split, @c), '') 
  --				SET @rid = @rid + 1  
  --			 END 
  --		INSERT @t(rid,col) VALUES (@rid,@c)  
  --		--去重
  --		INSERT @t1(rid,col) 
  --		SELECT  ROW_NUMBER () OVER (ORDER BY col) AS rid
  --			, col 
  --		FROM (SELECT DISTINCT col  FROM @t) t      
  --		RETURN 
  --	END
  --GO
  ```
-
- [[22_Code_Sql]]
   **自己寫的把多个item输入後放入一个临时表_eh**
  
  ```
  USE TCITASCFR
  GO
  CREATE FUNCTION [dbo].[MultipleValues_EH] (@InStr VARCHAR(MAX))
  RETURNS @TempTable TABLE (Temp_item VARCHAR(100) not null)
  AS
  BEGIN
  	SET @InStr = REPLACE(@InStr + ',', ',,', ',')
  	DECLARE @SP INT
  	DECLARE @VALUE VARCHAR(1000)
  	WHILE PATINDEX('%,%', @INSTR ) <> 0	
  		BEGIN
  			SELECT @SP = PATINDEX('%,%',@INSTR)
  			SELECT @VALUE = LEFT(@INSTR , @SP - 1)
  			SELECT @INSTR = STUFF(@INSTR, 1, @SP, '')
  			INSERT INTO @TempTable(Temp_item) VALUES (@VALUE)
  		END
  		RETURN
  	END
  GO
  
  DECLARE @MultipleValue VARCHAR(200), @InStr VARCHAR(200), @DEMO VARCHAR(200)
  SET @MultipleValue = '1,2'
  SET @InStr = 'A,B,C,De,f,GHG'
  SET @DEMO = 'ODW16008BCF,ODW16008BD0,ODW16008BD1,ODW16008BD2'
  
  SELECT * FROM TCITASCFR.dbo.MultipleValues(@MultipleValue)
  SELECT * FROM TCITASCFR.dbo.MultipleValues(@InStr)
  SELECT * FROM TCITASCFR.dbo.MultipleValues(@DEMO)
  
  -----------展开版本--------------------
  DECLARE @MultipleValue VARCHAR(200), @InStr VARCHAR(MAX), @SP INT, @VALUE VARCHAR(1000)
  CREATE TABLE #TempTable_eh (Temp_Item VARCHAR(100))
  
  --SET @InStr = 'ODW16008BCF,ODW16008BD0,ODW16008BD1,ODW16008BD2'
  SET @InStr = 'A,B,C,D'
  	BEGIN
  		SET @InStr = REPLACE(@InStr + ',', ',,', ',') --预设分段用","切割，怕原始资料最後面有逗点，所以要例外排除",,"
  		PRINT(@InStr)
  		WHILE PATINDEX('%,%', @INSTR ) <> 0
  		BEGIN
  			SELECT @SP = PATINDEX('%,%',@INSTR)
  			PRINT(@SP)
  			SELECT @VALUE = LEFT(@INSTR , @SP - 1)
  			PRINT(@VALUE)
  			SELECT @INSTR = STUFF(@INSTR, 1, @SP, '')
  			PRINT(@INSTR)
  			INSERT INTO #TempTable_eh(Temp_Item) VALUES (@VALUE)
  		END
  	END
  SELECT * FROM #TempTable_eh
  
  IF OBJECT_ID(N'tempdb..#TempTable_eh') IS NOT NULL
  BEGIN
      DROP TABLE #TempTable_eh
  End
  -----------展开版本--------------------
  ```
-
- [[22_Code_Sql]]
   **自己寫的报表相同栏位去从後放到另一张新表**
  ```
  DECLARE  @EmployeeIDs VARCHAR(MAX) = NULL, @CompanyID INT
  
  SET @CompanyID = 7766
  SET @EmployeeIDs = 'carie;exe2626;happy;sad;carie;'
  ----------------------------------------------------------------------------------------------------------------------------------------------------------
  
  IF OBJECT_ID('tempdb..#temp_EmployeeIDs') IS NOT NULL
  	BEGIN 
  		DROP TABLE  #temp_EmployeeIDs 
  	End
  
  CREATE TABLE #temp_EmployeeIDs 
  	(
  	 CompanyID INT 
  	,EmployeeID NVARCHAR(200) 
  	--,PRIMARY KEY 
  	--	(
  	--	[CompanyID]
  	--	,[EmployeeID]
  		--)
  	)
  	
  INSERT INTO #temp_EmployeeIDs
  SELECT @CompanyID AS CompanyID
  	,col AS EmployeeID
  FROM [TCITClient].[dbo].[F_Split_1](@EmployeeIDs ,N';')
  WHERE ISNULL(col,N'') <> N''
  
  select * from #temp_EmployeeIDs
  
  --without distinct
  SELECT  ROW_NUMBER() OVER (ORDER BY employeeid) AS rid, Employeeid 
  FROM (SELECT  employeeid  FROM #temp_EmployeeIDs) t      
  
  --with distinct
  SELECT  ROW_NUMBER() OVER (ORDER BY employeeid) AS rid, Employeeid 
  FROM (SELECT DISTINCT employeeid  FROM #temp_EmployeeIDs) t      
  
  select employeeid, count(*) from (
  	SELECT  ROW_NUMBER() OVER (ORDER BY employeeid) AS rid, Employeeid 
  	FROM (SELECT DISTINCT employeeid  FROM #temp_EmployeeIDs) t      
  ) s
  group by EmployeeID
  ```
-
- [[22_Code_Sql]]
   **JSM寫的更名語法(重新insert DIDIEditList後需要再執行此腳本)，基本上就是在資料表內搜尋特徵進行標準化**
  
  ```
  --更名
  UPDATE A SET A.[NAME] = REPLACE(A.[NAME],'Statistics','Satistics'), A.[TABLE_NAME] = REPLACE(A.[TABLE_NAME],'Statistics','Satistics')
  --SELECT * 
  FROM [dbo].[DIDIEditList] AS A 
  WHERE [NAME] LIKE '%Statistics%' --%Satistics%'  
  OR [TABLE_NAME] LIKE '%Statistics%' --%Satistics%'  
  
  UPDATE A SET A.[TCITASCFR_DB_Table] = REPLACE(A.[TCITASCFR_DB_Table],'Statistics','Satistics'), A.[From] = REPLACE(A.[From],'Statistics','Satistics')
  --SELECT REPLACE(A.[TCITASCFR_DB_Table],'Statistics','Satistics'), REPLACE(A.[From],'Statistics','Satistics'),* 
  FROM [dbo].[DIDITableAll] AS A
  WHERE [TCITASCFR_DB_Table] LIKE '%Statistics%' --%Satistics%'  
  OR [From]  LIKE '%Statistics%' --%Satistics%'  
  
  --加上[ ]
  
  UPDATE A SET A.[NAME] = '['+A.[NAME]+']'
  --SELECT * 
  FROM [dbo].[DIDIEditList] AS A 
  
  UPDATE A SET A.[NAME] = REPLACE(A.[NAME],'.','].[')
  --SELECT * 
  FROM [dbo].[DIDIEditList] AS A
  
  UPDATE A SET A.[TCITASCFR_DB_Table] = '['+A.[TCITASCFR_DB_Table]+']',
  A.[From] = '['+A.[From]+']'
  --SELECT * 
  FROM [dbo].[DIDITableAll] AS A 
  
  UPDATE A SET A.[TCITASCFR_DB_Table] = REPLACE(A.[TCITASCFR_DB_Table],'.','].['),
  A.[From] = REPLACE(A.[From],'.','].[')
  --SELECT * 
  FROM [dbo].[DIDITableAll] AS A 
  ```
-
- [[22_Code_Sql]]
   **自己寫的将不同列同一栏位的值用id为key合并，難在FOR XML PATH這語法的使用**
  https://blog.darkthread.net/blog/col-merge-benchmark
  
  ```
  --ID  Type   DESC
  --1    cpu     處理器
  --1    cpu     雙核心
  --1    cpu     800外頻 
  --2    HD      硬碟
  --2    HD      500G
  --2    HD      5400轉
  
  DECLARE @TEMP_EH TABLE(ID int, type varchar(10), product varchar(10))
  INSERT INTO  @TEMP_EH(ID,type,product) VALUES(1, 'cpu', '處理器'),(1, 'cpu', '800外頻' ),(1, 'cpu', '雙核心'),(2, 'HD', '硬碟'),(2, 'HD', '500G'), (3, 'HD', '5400轉')
  SELECT * FROM @TEMP_EH
  -->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  --1.用id撮合的
  SELECT T1.id, T1.type,
  (
    SELECT product + ','
    FROM   @TEMP_EH T2
    WHERE  T2.id = T1.id
    FOR XML PATH('')
  ) AS product
  FROM @TEMP_EH T1
  GROUP BY id, type
  -->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  --2.用type撮合
  SELECT T1.type,
  (
    SELECT product + ','
    FROM   @TEMP_EH T2
    WHERE  T2.type = T1.type
    FOR XML PATH('')
  ) AS product
  FROM @TEMP_EH T1
  GROUP BY type
  -->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  --理解後自己写的版本
  DECLARE @TEMP_EH TABLE(ID int, type varchar(10), product varchar(10))
  INSERT INTO  @TEMP_EH(ID,type,product) VALUES(1, 'cpu', '處理器'),(1, 'cpu', '800外頻' ),(1, 'cpu', '雙核心'),(2, 'HD', '硬碟'),(2, 'HD', '500G'), (3, 'HD', '5400轉')
  SELECT * FROM @TEMP_EH
  
  SELECT ID, 
  	type,
  	STUFF((SELECT ',' + product FROM @Temp_EH T2 WHERE T1.ID = T2.ID FOR XML PATH ('')),1,1,'') AS Products
  FROM @Temp_EH T1
  
  -->>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  ```
-
- [[22_Code_Sql]]
   **自己寫的脚本内drop function，重新寫新的function，概念很像drop temptable**
  
  ```
  IF OBJECT_ID('dbo.EricSayHiTesting') IS NOT NULL
  	BEGIN 
  		DROP FUNCTION dbo.EricSayHiTesting
  	End
  
  SET ANSI_NULLS ON
  GO
  SET QUOTED_IDENTIFIER ON
  GO
  
  CREATE FUNCTION dbo.EricSayHiTesting 
  (
  	@Word VARCHAR(10)
  )
  RETURNS VARCHAR(10)
  AS
  BEGIN
  	RETURN 'HELLO' + @Word
  END
  GO
  
  --commit
  select TCITASCFR.dbo.EricSayHiTesting('123112')
  ```
-
- [[22_Code_Sql]]
   **自己寫的accumulated 累加量**
  https://dotblogs.com.tw/ricochen/2011/08/24/34127
  
  ```
  --dbcc dropcleanbuffers
  --create table #mytable (c1 VARCHAR(1), c2 INT) 
  --insert into #mytable values('a',10),('b',99),('c',50)
  select * from #mytable
  --drop table #mytable
  
  --結果表
  declare @result table
  (
  rownumber int,
  c1 varchar(10),
  c2 int,
  total int default(0)
  )
  declare @starttime time(7),@endtime time(7),@elaspedtime numeric(20,7);
  set @starttime=GETDATE() 
  ;with cteA(rownumber,c1,c2)
  as(
  select row_number() over(order by c2,c1 desc) as 'rownumber',c1,c2 from #mytable 
  )
  --將來源資料塞入結果表
  insert into @result
  select cteA.*,0 from cteA
  
  declare @total int
  set @total=0
  update @result
  --設定變數與資料行相同的值
  set @total = total = @total + c2
  --結果 
  select t1.rownumber,t1.c1,t1.c2,t1.total as '累加量'  
  from @result t1
  set @endtime=GETDATE(); 
  set @elaspedtime = convert(integer, datediff(ms, @starttime, @endtime));
  select @elaspedtime as '花費時間(ms)' 
  ```
-
- [[22_Code_Sql]]
   **自己寫的dba考题汇总，從資料夾裡面找到的但DBA junior一題應該都答不出來，工作上也沒用到過**
  
  ```
  --问题1
  --遍历一个字符，并将其中的每个字符都作为一行返回，但是SQL没有循环操作。
  --例如，要将表EMP中ENAME值为KING的字符串显示为4行，每行中都包含“KING”中的一个字符。
  --注意：不能用循环语句，只能用一个sql来完成。
  
  --基础题
  --结果示例
  --C
  ---
  --K
  --I
  --N
  --G
  
  --CREATE TABLE [TCITDataProcessTemp].dbo.EH_IDTable (ID INT);
  --INSERT INTO [TCITDataProcessTemp].dbo.EH_IDTable VALUES(1),(2),(3),(4),(5),(6),(7),(8),(9),(10)
  --SELECT * FROM [TCITDataProcessTemp].dbo.EH_IDTable
  DECLARE @INPUT NVARCHAR(100), @N INT
  SET @INPUT = 'January,Febuary,November'
  SET @N =LEN(@INPUT)
  
  SELECT a.Temp_item, b.id, SUBSTRING(a.Temp_item, b.id, 1) C
  FROM (SELECT * FROM TCITASCFR.dbo.MultipleValues(@INPUT)) a,
  	 (SELECT ID FROM [TCITDataProcessTemp].dbo.EH_IDTable) b
  WHERE b.ID <= @N 
  	AND SUBSTRING(a.Temp_item, b.id, 1) <> ''
  ORDER BY a.Temp_item
  
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  
  --变体
  --结果示例
  --A		B
  ------------------
  --KING	G
  --ING	NG
  --NG	ING
  --G		KING
  DECLARE @INPUT NVARCHAR(10), @N INT
  SET @INPUT = 'FEBRUARY'
  SET @N =LEN(@INPUT)
  
  SELECT a.Temp_item, b.id, substring(a.Temp_item,1, len(a.Temp_item)-b.ID+1) A, SUBSTRING(a.Temp_item, 1, b.id) B
  FROM (SELECT * FROM TCITASCFR.dbo.MultipleValues(@INPUT)) a,
  (SELECT ID FROM [TCITDataProcessTemp].dbo.EH_IDTable) b
  WHERE b.ID <= @N
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  /*
  循环写法
  DECLARE @INPUT NVARCHAR(10), @N INT, @C INT
  SET @INPUT = 'FEBRARY'
  SET @C = 1
  SET @N =LEN(@INPUT)
  SELECT * FROM TCITASCFR.dbo.MultipleValues('FEBRARY')
  
  WHILE @C <= @N
  	BEGIN
  	PRINT(RIGHT(LEFT(@INPUT, @C), 1))
  	SET @C = @C +1
  	END
  */
  
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  --	问题2
  --从指定表的某列字符串（eg.ENAME）中删除所有的元音字母，结果见STRIPPED1：
  --eg.
  --ENAME	STRIPPED1
  ------------------------
  --SMITH	SMTH
  --ALLEN	LLN
  --WARD	WRD
  --注意：不能用循环语句，只能用一个sql来完成。
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  DECLARE @INPUT NVARCHAR(100), @N INT
  SET @INPUT = 'January,February,November'
  SET @N =LEN(@INPUT)
  --SELECT * FROM TCITASCFR.dbo.MultipleValues(@INPUT)
  
  SELECT REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(Temp_item, 'a', ''), 'e', ''), 'i', ''), 'o', ''), 'u', '')
  FROM TCITASCFR.dbo.MultipleValues(@INPUT)
  
  /*
  --自己从第一题硬干出来的组合栏位值的暴力写法
  SELECT T1.Temp_item,
  (
    SELECT SUBSTRING(T2.Temp_item, T2.id, 1) + ''
    FROM   
  	(
  	SELECT a.Temp_item, b.id, SUBSTRING(a.Temp_item, b.id, 1) C
  	FROM (SELECT * FROM TCITASCFR.dbo.MultipleValues(@INPUT)) a,
  		 (SELECT id FROM [TCITDataProcessTemp].dbo.EH_IDTable) b
  	WHERE b.ID <= @N 
  		AND SUBSTRING(a.Temp_item, b.id, 1) <> ''
  		AND SUBSTRING(a.Temp_item, b.id, 1) NOT IN ('a','e','i','o','u')
  	) T2
    WHERE  T2.Temp_item = T1.Temp_item
    FOR XML PATH('')
  ) AS C
  FROM 
  	(
  	SELECT a.Temp_item, b.id, SUBSTRING(a.Temp_item, b.id, 1) C
  	FROM (SELECT * FROM TCITASCFR.dbo.MultipleValues(@INPUT)) a,
  		 (SELECT id FROM [TCITDataProcessTemp].dbo.EH_IDTable) b
  	WHERE b.ID <= @N 
  		AND SUBSTRING(a.Temp_item, b.id, 1) <> ''
  		AND SUBSTRING(a.Temp_item, b.id, 1) NOT IN ('a','e','i','o','u')
  	)T1
  GROUP BY Temp_item
  */
  
  /*
  SELECT a.Temp_item, b.id, SUBSTRING(a.Temp_item, b.id, 1) C
  FROM (SELECT * FROM TCITASCFR.dbo.MultipleValues(@INPUT)) a,
  	 (SELECT ID FROM [TCITDataProcessTemp].dbo.EH_IDTable) b
  WHERE b.ID <= @N 
  	AND SUBSTRING(a.Temp_item, b.id, 1) <> ''
  	AND SUBSTRING(a.Temp_item, b.id, 1) NOT IN ('a','e','i','o','u')
  ORDER BY a.Temp_item
  */
  
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  
  --问题3
  --计算一个字符或字串在给定的字符串中出现的次数。考虑下面的字符串：
  --10,CLARK,MANAGER
  --要计算在这个字符串中有多少个逗号。
  --结果示例
  --cnt
  --2
  --注意：不能用循环语句，只能用一个sql来完成。
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  
  DECLARE @INPUT NVARCHAR(100), @Sep VARCHAR(10)
  SELECT @INPUT = '10,CLARK,MANAGER', @Sep = 'R'
  
  SELECT count(*)-1 FROM STRING_SPLIT(@INPUT, @Sep)
  --FLAW: STRING_SPLIT doesn't support @Sep with more than 1 character
  
  --标准解法
  DECLARE @testStr NVARCHAR(100)
  DECLARE @findStr NVARCHAR(10)
  SELECT @testStr = '10,CLARK,MANAGER', @findStr = 'AR'
  
  SELECT (LEN(@testStr)) - LEN(REPLACE(@testStr,@findStr,''))/LEN(@findStr) AS cnt 
  -->there's a mistake at (LEN(@testStr)")", it's at wrong position.
  
  
  --学习後ERIC改进写法
  DECLARE @INPUT NVARCHAR(100), @Sep VARCHAR(10)
  SELECT @INPUT = '10,CLARK,MANAGER', @Sep = 'LAR'
  
  SELECT @INPUT,
  	   @Sep,
  	   (LEN(@INPUT)) len_before,
  	   (LEN(@Sep)) len_replacer,
  	   (LEN(REPLACE(@INPUT, @Sep, ''))) len_afterReplace,
  	   (LEN(@INPUT) - LEN(REPLACE(@INPUT, @Sep, '')))/ LEN(@Sep) cnt_replacer
  
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  
  --FUNCTION [dbo].[MultipleValues_EH] 把多个item输入後放入一个临时表_eh
  --USE TCITASCFR
  --GO
  
  
  --CREATE FUNCTION [dbo].[MultipleValues_EH] (@InStr VARCHAR(MAX))
  --RETURNS @TempTable TABLE (Temp_item VARCHAR(100) not null)
  --AS
  --BEGIN
  --	SET @InStr = REPLACE(@InStr + ',', ',,', ',')
  --	DECLARE @SP INT
  --	DECLARE @VALUE VARCHAR(1000)
  --	WHILE PATINDEX('%,%', @INSTR ) <> 0	
  --		BEGIN
  --			SELECT @SP = PATINDEX('%,%',@INSTR)
  --			SELECT @VALUE = LEFT(@INSTR , @SP - 1)
  --			SELECT @INSTR = STUFF(@INSTR, 1, @SP, '')
  --			INSERT INTO @TempTable(Temp_item) VALUES (@VALUE)
  --		END
  --		RETURN
  --	END
  --GO
  
  ----commit
  
  --DECLARE @MultipleValue VARCHAR(200), @InStr VARCHAR(200), @DEMO VARCHAR(200)
  --SET @MultipleValue = '1,2'
  --SET @InStr = 'A,B,C,De,f,GHG'
  --SET @DEMO = 'ODW16008BCF,ODW16008BD0,ODW16008BD1,ODW16008BD2'
  
  --SELECT * FROM TCITASCFR.dbo.MultipleValues(@MultipleValue)
  --SELECT * FROM TCITASCFR.dbo.MultipleValues(@InStr)
  --SELECT * FROM TCITASCFR.dbo.MultipleValues(@DEMO)
  ```
-
- [[22_Code_Sql]]
   **自己寫的FK停用，如果Database有設定一些規定，在調整資料時就需要使用這些語法才能更改**
  
  ```
  -- 全部停用：資料庫內的 FOREIGN KEY 條件約束(CONSTRAINT)、CHECK 條件約束(CONSTRAINT)
  USE TCITPMA
  GO
  EXEC sp_MSforeachtable @command1="ALTER TABLE ? NOCHECK CONSTRAINT ALL"
  GO
  
  USE [TCITClient]
  GO
  EXEC sp_MSforeachtable @command1="ALTER TABLE [CompanyInfo].[Employee] WITH NOCHECK CHECK CONSTRAINT ALL"
  GO
  
  USE TCITEAP
  GO
  EXEC sp_MSforeachtable @command1="ALTER TABLE ? NOCHECK CONSTRAINT ALL"
  GO
   
  -- 全部啟用：資料庫內的 FOREIGN KEY 條件約束(CONSTRAINT)、CHECK 條件約束(CONSTRAINT)
  -- 不檢查現有資料
  USE TCITPMA
  GO
  EXEC sp_MSforeachtable @command1="ALTER TABLE ? WITH NOCHECK CHECK CONSTRAINT ALL"
  GO
  
  -- 全部停用：資料庫內的 FOREIGN KEY 條件約束(CONSTRAINT)、CHECK 條件約束(CONSTRAINT)
  USE [TCITClient]
  GO
  EXEC sp_MSforeachtable @command1="ALTER TABLE [CompanyInfo].[Employee] NOCHECK CONSTRAINT ALL"
  GO
  
  USE TCITEAP
  GO
  EXEC sp_MSforeachtable @command1="ALTER TABLE ? WITH NOCHECK CHECK CONSTRAINT ALL"
  GO
  ```
-
- [[22_Code_Sql]]
   **自己寫的IF ELSE研究**
  ```
  declare @a int, @b int, @c int, @d int
  SET @a = 1
  SET @b = 1
  SET @c = 1
  SET @d = 1
  
  IF 
  (SELECT top 1 SSN				
  		FROM [TCITEAP].[ESOPBasicInfo].[SettlementRegistrationConfig] WITH(NOLOCK)
  		WHERE [CompanyID] IN (140, 258, 264, 202) AND STATUS <> 3) IS NULL
  BEGIN
  	SET @a = 2
  	print('nono')
  END
  else 
  BEGIN
  	SELECT @b = 2, @c = 3
  	set @b = 10
  END
  SET @d = 4
  
  select (@a)
  select (@b)
  select (@c)
  select (@d)
  ```
-
- [[22_Code_Sql]]
   **自己寫的lock不完全会导致有资安漏洞，如果碰到這種絕對嚴謹的邏輯lock選擇要嚴謹**
  ```
   USE TCITDataProcessTemp 
   GO
  
  CREATE TABLE dbo.EH20220421
  (
      MemberID INT PRIMARY KEY,
      MemberName NVARCHAR(100) NOT NULL,
      ActualBalance MONEY NOT NULL
  )
  GO
  
  INSERT INTO dbo.EH20220421
  (
      MemberID,
      MemberName,
      ActualBalance
  )
  VALUES (1, 'Max W', 1000000)
  
  --COMMIT;
  
   
  DECLARE @TransferMoney MONEY = 1000000
  
  BEGIN TRAN
  
  IF EXISTS(
      SELECT *
      FROM dbo.EH20220421 WITH(XLOCK, ROWLOCK)
      WHERE MemberID = 1 AND ActualBalance >= @TransferMoney
  )
  BEGIN
      WAITFOR DELAY '00:00:10'
  
      UPDATE dbo.EH20220421
      SET ActualBalance = ActualBalance - @TransferMoney
      WHERE MemberID = 1
  END
  
  COMMIT;
  
  --ROLLBACK
  SELECT * FROM dbo.EH20220421
  
  --DROP TABLE dbo.EH20220421
  ```
-
- [[22_Code_Sql]]
   **自己寫的practice partition，基本的sql 編號應用**
  
  ```
  --练习partition
  
  select * from TCITDataProcessTemp.dbo.EH20220407_msz
  
  select ROW_NUMBER() OVER(PARTITION BY username ORDER BY EmployeeID) [Number], *  
  FROM TCITDataProcessTemp.dbo.EH20220407_msz
  
  select ROW_NUMBER() OVER(PARTITION BY username ORDER BY username) [Number], *  
  FROM TCITDataProcessTemp.dbo.EH20220407_msz
  
  select ROW_NUMBER() OVER(PARTITION BY Companyid ORDER BY companyid) [Number], *  
  FROM TCITDataProcessTemp.dbo.EH20220407_msz
  
  select * from (
  select ROW_NUMBER() OVER(PARTITION BY username ORDER BY EmployeeID) [Number], *  
  FROM TCITDataProcessTemp.dbo.EH20220407_msz
  )A
  WHERE A.Number > 1
  
  
  select *,ROW_NUMBER() OVER(PARTITION BY username ORDER BY EmployeeID), SUM(CompanyID) OVER(PARTITION BY USERNAME ORDER BY EMPLOYEEID)
  FROM TCITDataProcessTemp.dbo.EH20220407_msz
  
  --->>>>
  --->>>>
  select * from
  (
  SELECT ROW_Number() OVER (PARTITION BY DTR.DocumentName  ORDER BY DTR.DocumentName ) [Number],
  C.CompanyName AS [CompanyName]
  	  ,D.DocumentTemplateID AS [DocumentTemplateID]
  	  ,DTR.DocumentName AS [FileName]
  FROM [SigningDocument].[dbo].[DocumentTemplateResource] DTR
  INNER JOIN [SigningDocument].[dbo].[Document] D
  	ON DTR.DocumentTemplateID = D.DocumentTemplateID
  INNER JOIN [TCITClient].[CompanyInfo].[Company] C
  	ON C.CompanyID = D.CompanyID
  where companyname <> 'Demo-20'
  --ORDER BY [FileName], CompanyName
  )T1
  
  SELECT C.CompanyName AS [CompanyName]
  	  ,D.DocumentTemplateID AS [DocumentTemplateID]
  	  ,DTR.DocumentName AS [FileName]
  FROM [SigningDocument].[dbo].[DocumentTemplateResource] DTR
  INNER JOIN [SigningDocument].[dbo].[Document] D
  	ON DTR.DocumentTemplateID = D.DocumentTemplateID
  INNER JOIN [TCITClient].[CompanyInfo].[Company] C
  	ON C.CompanyID = D.CompanyID
  ORDER BY D.DocumentTemplateID
  --->>>>
  --->>>>
  --->>>>
  --->>>>
  ```
-
- [[22_Code_Sql]]
   **自己寫的sql加解密**
  http://jengting.blogspot.com/2014/01/encrypt-decrypt-data.html
  
  ```
  USE TCITASCFR 
  GO
  
  IF OBJECT_ID('PWData') IS NOT NULL
    DROP TABLE PWData
  
  CREATE TABLE PWData
  (
    MemID INT PRIMARY KEY CLUSTERED,
    MemName nvarchar(10),
    PW varchar(100) NOT NULL,
    EncryptPW varbinary(100) -- 資料型態也是重點之一
  )
  GO
  
  INSERT INTO PWData (MemID,MemName,PW) VALUES
    (1,N'張三','123'),
    (2,N'李四','456'),
    (3,N'王五','789')
  GO
  --COMMIT
  
  --加密流程
  -- 1. 建立憑證需先建 Database Master Key
  CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'P@ssw0rd'
  GO
  
  -- 2. 建立憑證
  CREATE CERTIFICATE CertDemo
    AUTHORIZATION dbo
    WITH SUBJECT = 'CertDemo',
    START_DATE = '5/30/2022', -- 不指定為建立當下的日期
    EXPIRY_DATE = '5/30/2023' -- 不指定為 Start_Date 加 1 年為 Expiry_Date
  GO
  
  -- 3. 建立以憑證加密的對稱金鑰
  CREATE SYMMETRIC KEY KeyDemo
    AUTHORIZATION dbo
    WITH ALGORITHM = TRIPLE_DES          -- 加密演算法
    ENCRYPTION BY CERTIFICATE CertDemo   -- 利用 CertDemo Certificate 來加密 KeyDemo Key
  GO
  
  -- 4. 對密碼欄位進行加密
  -- 4.1 透過憑證解密來開啟對稱金鑰
  OPEN SYMMETRIC KEY KeyDemo DECRYPTION BY CERTIFICATE CertDemo
  GO
  
  -- 4.2 使用 EncryptByKey 將密碼資料加密
  UPDATE dbo.PWData
  SET EncryptPW = EncryptByKey(Key_GUID('KeyDemo'),PW)
  GO
  
  -- 4.3 關閉所有對稱金鑰
  CLOSE ALL SYMMETRIC KEYS
  GO
  
  -- 4.4 檢查加密結果
  SELECT * FROM PWData
  
  解密流程
  -- 1. 透過憑證解密來開啟對稱金鑰
  OPEN SYMMETRIC KEY KeyDemo DECRYPTION BY CERTIFICATE CertDemo
  
  -- 2. 使用 DecryptByKey 讀取解密資料，並透過 CAST 轉回字元格式
  SELECT 
    * ,
    CAST(DecryptByKey(EncryptPW) AS varchar(100)) AS DecryptPW
  FROM dbo.PWData
  
  --2.3.關閉所有對稱金鑰
  CLOSE ALL SYMMETRIC KEYS
  
  SELECT * FROM sys.certificates
  ```
-
- [[22_Code_Sql]]
   **自己寫的Sync table within dbs_20220527**
  https://dotblogs.com.tw/jamesfu/2022/05/25/Local_Replication
  
  ```
  --symchronize within dbs, on one server.
  --https://dotblogs.com.tw/jamesfu/2022/05/25/Local_Replication
  --target : to symc sbctemp.[dbo].[SBCTasktPlan] to tcitdataprocesstemp.dbo.eh20220527_sbctasktplan
  
  select * from sbctemp.[dbo].[SBCTasktPlan]
  
  USE [tcitdataprocesstemp]
  GO
  CREATE SCHEMA [mock] AUTHORIZATION [dbo]
  GO
  
  USE [tcitdataprocesstemp]
  GO
  CREATE SYNONYM [mock].[eh20220527_sbctasktplan] FOR [sbctemp].[dbo].[SBCTasktPlan]
  GO
  
  USE [tcitdataprocesstemp]
  GO
  CREATE VIEW dbo.[eh20220527_sbctasktplan]
  AS
  SELECT PlanID, PlanName, ReportID, ReportName, XMLFileName
  		, Status, ListedSite, CloseTimeDay, Interval, IntervalDatepart
  		, IntervalDay, ExecuteDate, NextExecuteDate, TimeZone, CreateDate, UpdateDate
  FROM [mock].[eh20220527_sbctasktplan]
  
  select * from  [tcitdataprocesstemp].[mock].[eh20220527_sbctasktplan]
  select * from  [tcitdataprocesstemp].dbo.[eh20220527_sbctasktplan]
  
  USE [tcitdataprocesstemp]
  GO
  CREATE TRIGGER dbo.TRIG_eh20220527_sbctasktplan
     ON  dbo.[eh20220527_sbctasktplan]
     INSTEAD OF INSERT,DELETE,UPDATE
  AS 
  BEGIN
  	SET NOCOUNT ON;
      -- Insert statements for trigger here
  END
  GO
  
  SELECT * FROM eh20220527_sbctasktplan
  --trying to delete here,it won't be deleted at all, becasue the trigger cheating the sql.
  DELETE FROM tcitdataprocesstemp.dbo.eh20220527_sbctasktplan WHERE planid = 7
  
  --the data will be deleted with this mock schema.
  DELETE FROM tcitdataprocesstemp.mock.eh20220527_sbctasktplan WHERE planid = 7
  
  SELECT * FROM tcitdataprocesstemp.dbo.eh20220527_sbctasktplan
  SELECT * FROM tcitdataprocesstemp.mock.eh20220527_sbctasktplan
  
  --rollback
  --COMMIT
  
  --测试如果修改资料表主体的资料，复制表是否会连动，答案会，包含.dbo.eh20220527_sbctasktplan & .mock.eh20220527_sbctasktplan都有连动
  SELECT *													  
  --UPDATE A SET A.STATUS = 5 
  FROM sbctemp.[dbo].[SBCTasktPlan] A
  WHERE PLANID = 7
  
  SELECT * FROM tcitdataprocesstemp.dbo.eh20220527_sbctasktplan
  SELECT * FROM tcitdataprocesstemp.mock.eh20220527_sbctasktplan
  --COMMIT
  ```
-
- [[22_Code_Sql]]
   **自己寫的TryCatchExample，用來做抱錯時的判斷**
  
  ```
  DECLARE @SP_NO VARCHAR(10), @CompanyID INT
  SET @SP_NO = 'DIDI02'
  SET @CompanyID = 166
  
  BEGIN TRY  
      -- Table does not exist; object name resolution  
      -- error not caught.  
  	PRINT '1-START'
  	EXEC [dbo].[TEST_TRY_CATCH] 
  	SELECT '1-END'
  	EXEC [dbo].[TEST_TRY_CATCH_Error]
  	SELECT 'END'
  	SELECT '2-START'
  	EXEC [dbo].[TEST_TRY_CATCH] 
  	SELECT '2-END'
  END TRY  
  BEGIN CATCH
  	
  	INSERT INTO [SBCTemp].[dbo].[SBC_SP_Error_Log] (ExecDate,CmpanyID,SP_No,ErrorProcedure,ErrorMessage) 
  	VALUES (GETDATE(),@CompanyID,@SP_No,ERROR_PROCEDURE(),ERROR_MESSAGE())
  	
  	SELECT
  	GETDATE() AS 'ExecDate',@CompanyID AS CmpanyID,@SP_NO AS SP_No
          ,ERROR_PROCEDURE() AS ErrorProcedure  
          ,ERROR_MESSAGE() AS ErrorMessage;  
  
  END CATCH  
  ```
-
- [[22_Code_Sql]]
   **自己寫的unpivot三个日期比大小，取最大，相應欄位比大小取值**
  
  ```
  三个日期比大小，取最大
  create table tcitdataprocesstemp.dbo.eh20201120 (id int identity(1,1), date1 datetime, date2 datetime, date3 datetime)
  insert into tcitdataprocesstemp.dbo.eh20201120 values ('1/10/2012','1/2/2012','1/3/2012'), ('1/1/2012',null,'1/3/2012'), ('1/1/2012','1/2/2012',null)
  SELECT id,
         Max(date123) AS latestdate
  FROM   (SELECT id,
                 date1,
                 date2,
                 date3
          FROM   tcitdataprocesstemp.dbo.eh20201120) src
         UNPIVOT (date123
                 FOR dates IN ([date1],
                               [date2],
                               [date3])) unpvt
  GROUP  BY id 
  ```
-
- [[22_Code_Sql]]
   **自己寫的update top 3 rows写法，就是想更新最新的某幾筆，但是一般使用排序時沒辦法執行update語法**
  
  ```
  select * 
  --update rrl set rrl.computedcounter = 4, rrl.reportrequeststatus = 3
  FROM TCITClient.[ReportInfo].[ReportRequestList] rrl
  WHERE reporttypeid = 4328
  ORDER BY CreationDate DESC
  
  
  WITH CTE AS 
  ( 
  SELECT TOP 3 * 
  FROM TCITClient.[ReportInfo].[ReportRequestList] rrl
  WHERE reporttypeid = 4328
  ORDER BY CreationDate DESC
  ) 
  UPDATE CTE SET computedcounter = 4, reportrequeststatus = 3
  
  
  
  select *
  --update rrl set rrl.computedcounter = 4, rrl.reportrequeststatus = 3
  FROM TCITClient.[ReportInfo].[ReportRequestList] rrl
  WHERE reporttypeid = 4328
  AND rrl.ReportRequestID IN (SELECT TOP 3 ReportRequestID FROM TCITClient.[ReportInfo].[ReportRequestList] rrl WHERE reporttypeid = 4328 ORDER BY CreationDate DESC
  )
  
  --commit
  ```
-
- [[22_Code_Sql]]
   **自己寫的测试每次复制demo公司配置，Split Function取代信箱所需要判斷切割欄位**
  
  ```
  SELECT parametervalue
  FROM [TCITClient].[CompanyInfo].[CompanyParameter] 
  where --CompanyID = 263 --and parameterid = 2
  parametervalue like '%@%'
  and parametervalue like '%[A-Za-z0-9]@[A-Za-z0-9]%'
  
  parametervalue like '%\w[-\w.+]*@([A-Za-z0-9][-A-Za-z0-9]+.)+[A-Za-z]{2,14}%'
  
  SELECT col FROM [TCITClient].[dbo].[F_Split_2](',|;| |"' ,N'|')
  
  DECLARE @Contents VARCHAR(MAX), @CompanyID INT
  SET @Contents = 'carie@exe2626;happy@sad carie@good'
  
  SET NOCOUNT ON;
  
  	IF OBJECT_ID('tempdb..#temp_multiEmails') IS NOT NULL
  		BEGIN 
  			DROP TABLE  #temp_multiEmails
  		End
  
  	CREATE TABLE #temp_multiEmails
  		(
  		 AlignNumber INT 
  		,Content NVARCHAR(200) 
  		,PRIMARY KEY 
  			(
  			[AlignNumber]
  			,[Content]
  			)
  		)
  		
  	INSERT INTO #temp_multiEmails
  	SELECT rid
  		,col AS Content
  	FROM [TCITClient].[dbo].[F_Split_2](@Contents ,N';')
  	WHERE ISNULL(col,N'') <> N''
  
  SELECT * FROM　#temp_multiEmails
  
  ------[dbo].[F_Split_2](待分割，分隔符号)  FUNCTION 写法----
  
  --USE [TCITClient]
  --GO
  
  --/****** Object:  UserDefinedFunction [dbo].[F_Split_2]  Script Date: 2022/3/24 14:45:21 ******/
  --SET ANSI_NULLS ON
  --GO
  
  --SET QUOTED_IDENTIFIER ON
  --GO
  
  --CREATE FUNCTION [dbo].[F_Split_2](@c NVARCHAR(MAX),@split VARCHAR(2)) 
  --	RETURNS @t1 TABLE(rid BIGINT, col NVARCHAR(MAX)) 
  --	AS  
  --	BEGIN 
  --		DECLARE @rid BIGINT 
  --		SET @rid=1
  --		WHILE (CHARINDEX(@split,@c) <> 0) 
  --			BEGIN
  --				DECLARE @t TABLE
  --					(
  --					rid BIGINT
  --					,col NVARCHAR(MAX)
  --					) 
  --				INSERT @t(rid, col) VALUES (@rid, SUBSTRING(@c, 1, CHARINDEX(@split, @c) - 1)) 
  --				SET @c = STUFF(@c, 1, CHARINDEX(@split, @c), '') 
  --				SET @rid = @rid + 1  
  --			 END 
  --		INSERT @t(rid,col) VALUES (@rid,@c)  
  --		--去重
  --		INSERT @t1(rid,col) 
  --		SELECT  ROW_NUMBER () OVER (ORDER BY col) AS rid
  --			, col 
  --		FROM (SELECT DISTINCT col  FROM @t) t      
  --		RETURN 
  --	END
  --GO
  ```
-
- [[22_Code_Sql]]
   **自己寫的测试每次复制demo公司配置，其中各式信箱的取代**
  
  ```
  DECLARE @C1 INT = 0, @C2 INT = 0, @Contents VARCHAR(MAX), @DemoCompanyID INT = 49, @TargetCompanyID INT = 136, @ModifiedEmail VARCHAR(30) = 'Jane.wei@tcghl.com'
  IF OBJECT_ID('tempdb..#temp_Split') IS NOT NULL
  	BEGIN 
  		DROP TABLE  #temp_Split
  	End
  CREATE TABLE #temp_Split(
  	ID INT
  	,Split VARCHAR(5)
  	)
  INSERT INTO #temp_Split VALUES (1, '"'), (2,';'), (3,','), (4, ':')
  --SELECT * FROM #temp_Split
  
  IF OBJECT_ID('tempdb..#temp_CompanyParameter') IS NOT NULL
  	BEGIN 
  		DROP TABLE  #temp_CompanyParameter
  	End
  CREATE TABLE #temp_CompanyParameter(
  	ID INT
  	,CompanyID INT
  	,ParameterID INT
  	,ParameterValue NVARCHAR(MAX)
  	,ReplacedParameterValue NVARCHAR(MAX)
  	,Status TINYINT
  	,Creator NVARCHAR(40)
  	,CreationDate DATETIME
  	,Modifier NVARCHAR(40)
  	,ModifiedDate DATETIME
  	)
  
  INSERT INTO #temp_CompanyParameter
  SELECT ROW_NUMBER() OVER(PARTITION BY CompanyID ORDER BY CompanyID) ID
  	   ,@DemoCompanyID CompanyID
  	   ,ParameterID, ParameterValue, NULL ReplacedParameterValue, Status, Creator, CreationDate, Modifier, ModifiedDate
  FROM [TCITClient].[CompanyInfo].[CompanyParameter]
  WHERE CompanyID = @TargetCompanyID
  	AND ParameterID NOT IN (32, 36)
  	AND ParameterValue LIKE '%@%'
  
  --SELECT '#temp_CompanyParameter before replacing email', ID, CompanyID, ParameterID, ParameterValue, ReplacedParameterValue FROM #temp_CompanyParameter
  
  WHILE @C1 < (SELECT MAX(ID) FROM #temp_CompanyParameter)
  	--<<<<<<<<<<<<<
  	BEGIN
  	SET @C1 = @C1 + 1
  	--SELECT @C1
  	--SELECT ParameterID FROM #temp_CompanyParameter WHERE ID = @C1
  	WHILE @C2 < (SELECT MAX(ID) FROM #temp_Split)
  		--<><><><><><><><><><><><><<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
  		BEGIN
  		SET @C2 = @C2 + 1
  		--SELECT @C1 SELECT @C2 SELECT ('-----')
  		SET @Contents = (SELECT parametervalue FROM #temp_CompanyParameter where parameterid = (SELECT ParameterID FROM #temp_CompanyParameter WHERE ID = @C1))
  		SET NOCOUNT ON;
  
  		IF OBJECT_ID('tempdb..#temp_multiEmails') IS NOT NULL
  			BEGIN 
  				DROP TABLE  #temp_multiEmails
  			End
  
  		CREATE TABLE #temp_multiEmails
  			(
  			 AlignNumber INT 
  			,Content NVARCHAR(MAX) 
  			)
  
  		IF CHARINDEX((SELECT Split FROM #temp_Split WHERE ID = @C2), @Contents) <> 0
  			BEGIN
  				INSERT INTO #temp_multiEmails
  				SELECT rid
  					,col AS Content
  				FROM [TCITClient].[dbo].[F_Split_1](@Contents , (SELECT Split FROM #temp_Split WHERE ID = @C2))
  				WHERE ISNULL(col,N'') <> N''
  				ORDER BY rid
  			END
  		--SELECT '#temp_multiEmails before±Æ§Ç',* FROM¡@#temp_multiEmails
  
  		----SELECT AlignNumber, Content, PATINDEX(CONCAT('%',Content,'%'), (SELECT parametervalue FROM #temp_CompanyParameter where parameterid = 270))
  		--UPDATE a SET a.AlignNumber = PATINDEX(CONCAT('%',Content,'%'), (SELECT parametervalue FROM #temp_CompanyParameter where parameterid = 270))
  		--FROM #temp_multiEmails a
  		--SELECT '#temp_multiEmails after±Æ§Ç',* FROM¡@#temp_multiEmails
  
  		UPDATE a SET a.Content = @ModifiedEmail
  		FROM #temp_multiEmails a
  		WHERE Content LIKE '%@%'
  
  		UPDATE #temp_CompanyParameter SET ReplacedParameterValue = 
  		(
  			SELECT TOP 1 STUFF(
  									(SELECT 
  											(SELECT Split FROM #temp_Split WHERE ID = @C2) 
  											+ Content 
  									 FROM #temp_multiEmails ORDER BY AlignNumber ASC FOR XML PATH (''))
  								 ,1,1,''
  								 ) AS ParameterValue
  		)
  		FROM #temp_multiEmails
  		WHERE ParameterID = (SELECT ParameterID FROM #temp_CompanyParameter WHERE ID = @C1)
  			AND ReplacedParameterValue IS NULL
  		END
  		--<><><><><><><><><><><><><<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
  
  	SET @C2 = 0
  	END
  	--<<<<<<<<<<<<<
  
  	UPDATE #temp_CompanyParameter SET ReplacedParameterValue = @ModifiedEmail
  	FROM #temp_CompanyParameter
  	WHERE ReplacedParameterValue IS NULL
  
  SELECT '#temp_CompanyParameter after replacing email', ID, CompanyID, ParameterID, ParameterValue, ReplacedParameterValue FROM #temp_CompanyParameter
  
  IF  OBJECT_ID('tempdb..#temp_Split') IS NOT NULL
  	BEGIN 
  		DROP TABLE  #temp_Split
  	End
  
  IF OBJECT_ID('tempdb..#temp_CompanyParameter') IS NOT NULL 
  	BEGIN 
  		DROP TABLE  #temp_CompanyParameter
  	End
  
  IF OBJECT_ID('tempdb..#temp_multiEmails') IS NOT NULL
  	BEGIN 
  		DROP TABLE  #temp_multiEmails
  	End
  ```
-
- [[22_Code_Sql]]
   **自己寫的测试每次复制demo公司配置，當初完成的腳本**
  
  ```
  /*公司配置，
  注意：
  去掉32、36参数
  邮箱调整为Jane.wei@tcghl.com
  电话号码调整为失效的
  股票代码不变
  */
  
  --公司信息，主要修改SpecState,StockCode  
  Select * --update C Set C.StockCode = 'MANU'
  from  TCITClient.CompanyInfo.Company  C
  where CompanyID =49
  --------------------------------------------------------------------------------------------------------------------
  
  
  --操作第一步将备份档名取代    EH20220511_263todemo49
  DECLARE @C1 INT = 0, @C2 INT = 0, @Contents VARCHAR(MAX), @CompanyID INT
  DECLARE @DemoCompanyID INT, @TargetCompanyID INT, @ExecuteStep INT, @ModifiedEmail VARCHAR(30)
  SET @DemoCompanyID = 49
  SET @TargetCompanyID = 263
  SET @ModifiedEmail = 'Jane.wei@tcghl.com'
  SET @ExecuteStep = 0 
  --目前操作只针对6个table
  --@ExecuteStep = 0 查看两家公司的table
  --@ExecuteStep = 1 将2,3,4复制、删除、修改步骤操作全部一键执行
  --@ExecuteStep = 2 备份DemoCompany的资料表
  --@ExecuteStep = 3 删除DemoCompany的资料
  --@ExecuteStep = 4 将TargetCompany资料复制後放到DemoCompany(删除32.36参数，信箱修改，电话修改)
  --@ExecuteStep = 5 查看DemoCompany备份档
  
  IF @ExecuteStep = 0
  	BEGIN
  		SELECT * FROM [TCITClient].[CompanyInfo].[CompanyParameter] where CompanyID = @DemoCompanyID
  		SELECT * FROM [TCITClient].[CompanyInfo].[CompanyParameter] where CompanyID = @TargetCompanyID
  
  		SELECT * FROM [TCITEAP].[ESOPBasicInfo].[CompanyInfoByESOP] where CompanyID = @DemoCompanyID
  		SELECT * FROM [TCITEAP].[ESOPBasicInfo].[CompanyInfoByESOP] where CompanyID	= @TargetCompanyID
  
  		SELECT * FROM [TCITEAP].[ESOPBasicInfo].[ExerciserFeeScheme] where CompanyID = @DemoCompanyID
  		SELECT * FROM [TCITEAP].[ESOPBasicInfo].[ExerciserFeeScheme] where CompanyID = @TargetCompanyID
  
  		SELECT * FROM [TCITEAP].[ESOPBasicInfo].[ExerciseFeeCode] where CompanyID = @DemoCompanyID
  		SELECT * FROM [TCITEAP].[ESOPBasicInfo].[ExerciseFeeCode] where CompanyID = @TargetCompanyID
  
  		SELECT * FROM [TCITEAP].[ESOPBasicInfo].[ExerciseFeeCodeDetail] where CompanyID = @DemoCompanyID
  		SELECT * FROM [TCITEAP].[ESOPBasicInfo].[ExerciseFeeCodeDetail] where CompanyID = @TargetCompanyID
  
  		SELECT * FROM [TCITClient].[CompanyInfo].[CompanyReportMapping] where CompanyID = @DemoCompanyID
  		SELECT * FROM [TCITClient].[CompanyInfo].[CompanyReportMapping] where CompanyID = @TargetCompanyID
  	END
  
  
  IF @ExecuteStep in (1,2)
  	BEGIN
  		SELECT * INTO TCITDATAPROCESSTEMP.DBO.EH20220511_263todemo49_1
  		FROM [TCITClient].[CompanyInfo].[CompanyParameter] where CompanyID = @DemoCompanyID
  
  		SELECT * INTO TCITDATAPROCESSTEMP.DBO.EH20220511_263todemo49_2
  		FROM [TCITEAP].[ESOPBasicInfo].[CompanyInfoByESOP] where CompanyID = @DemoCompanyID
  
  		SELECT * INTO TCITDATAPROCESSTEMP.DBO.EH20220511_263todemo49_3
  		FROM [TCITEAP].[ESOPBasicInfo].[ExerciserFeeScheme] where CompanyID = @DemoCompanyID
  
  		SELECT * INTO TCITDATAPROCESSTEMP.DBO.EH20220511_263todemo49_4
  		FROM [TCITEAP].[ESOPBasicInfo].[ExerciseFeeCode] where CompanyID = @DemoCompanyID
  
  		SELECT * INTO TCITDATAPROCESSTEMP.DBO.EH20220511_263todemo49_5
  		FROM [TCITEAP].[ESOPBasicInfo].[ExerciseFeeCodeDetail] where CompanyID = @DemoCompanyID
  
  		SELECT * INTO TCITDATAPROCESSTEMP.DBO.EH20220511_263todemo49_6
  		FROM [TCITClient].[CompanyInfo].[CompanyReportMapping] where CompanyID = @DemoCompanyID
  	END
  
  
  
  IF @ExecuteStep in (1,3)
  	BEGIN
  		DELETE FROM [TCITClient].[CompanyInfo].[CompanyParameter] where CompanyID = @DemoCompanyID
  		DELETE FROM [TCITEAP].[ESOPBasicInfo].[ExerciseFeeCodeDetail] where CompanyID = @DemoCompanyID
  		DELETE FROM [TCITEAP].[ESOPBasicInfo].[ExerciseFeeCode] where CompanyID = @DemoCompanyID
  		DELETE FROM [TCITEAP].[ESOPBasicInfo].[ExerciserFeeScheme] where CompanyID = @DemoCompanyID
  		DELETE FROM [TCITEAP].[ESOPBasicInfo].[CompanyInfoByESOP] where CompanyID = @DemoCompanyID
  		DELETE FROM [TCITClient].[CompanyInfo].[CompanyReportMapping] where CompanyID = @DemoCompanyID
  	END
  
  
  IF @ExecuteStep in (1,4)
  	BEGIN
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  --先把32,36参数剔除，并将非信箱相关的参数复制到指定公司
  		INSERT INTO [TCITClient].[CompanyInfo].[CompanyParameter]
  		SELECT @DemoCompanyID CompanyID
  			   ,ParameterID, ParameterValue, Status, Creator, CreationDate, Modifier, ModifiedDate 
  		FROM [TCITClient].[CompanyInfo].[CompanyParameter]
  		WHERE CompanyID = @TargetCompanyID
  			AND ParameterID NOT IN (32, 36)
  			AND ParameterValue NOT LIKE '%@%'
  
  --处理信箱相关Value
  		--<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  		IF OBJECT_ID('tempdb..#temp_Split') IS NOT NULL
  			BEGIN 
  				DROP TABLE  #temp_Split
  			End
  		CREATE TABLE #temp_Split(
  			ID INT
  			,Split VARCHAR(5)
  			)
  		INSERT INTO #temp_Split VALUES (1, '"'), (2,';'), (3,','), (4, ':')
  		--SELECT * FROM #temp_Split
  
  		IF OBJECT_ID('tempdb..#temp_CompanyParameter') IS NOT NULL
  			BEGIN 
  				DROP TABLE  #temp_CompanyParameter
  			End
  		CREATE TABLE #temp_CompanyParameter(
  			ID INT
  			,CompanyID INT
  			,ParameterID INT
  			,ParameterValue NVARCHAR(MAX)
  			,ReplacedParameterValue NVARCHAR(MAX)
  			,Status TINYINT
  			,Creator NVARCHAR(40)
  			,CreationDate DATETIME
  			,Modifier NVARCHAR(40)
  			,ModifiedDate DATETIME
  			)
  
  		INSERT INTO #temp_CompanyParameter
  		SELECT ROW_NUMBER() OVER(PARTITION BY CompanyID ORDER BY CompanyID) ID
  			   ,@DemoCompanyID CompanyID
  			   ,ParameterID, ParameterValue, NULL ReplacedParameterValue, Status, Creator, CreationDate, Modifier, ModifiedDate
  		FROM [TCITClient].[CompanyInfo].[CompanyParameter]
  		WHERE CompanyID = @CompanyID
  			AND ParameterID NOT IN (32, 36)
  			AND ParameterValue LIKE '%@%'
  
  		--SELECT '#temp_CompanyParameter before replacing email', ID, CompanyID, ParameterID, ParameterValue, ReplacedParameterValue FROM #temp_CompanyParameter
  
  		WHILE @C1 < (SELECT MAX(ID) FROM #temp_CompanyParameter)
  			--<<<<<<<<<<<<<
  			BEGIN
  			SET @C1 = @C1 + 1
  			--SELECT @C1
  			--SELECT ParameterID FROM #temp_CompanyParameter WHERE ID = @C1
  			WHILE @C2 < (SELECT MAX(ID) FROM #temp_Split)
  				--<><><><><><><><><><><><><<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
  				BEGIN
  				SET @C2 = @C2 + 1
  				--SELECT @C1 SELECT @C2 SELECT ('-----')
  				SET @Contents = (SELECT parametervalue FROM #temp_CompanyParameter where parameterid = (SELECT ParameterID FROM #temp_CompanyParameter WHERE ID = @C1))
  				SET NOCOUNT ON;
  
  				IF OBJECT_ID('tempdb..#temp_multiEmails') IS NOT NULL
  					BEGIN 
  						DROP TABLE  #temp_multiEmails
  					End
  
  				CREATE TABLE #temp_multiEmails
  					(
  					 AlignNumber INT 
  					,Content NVARCHAR(MAX) 
  					)
  
  				IF CHARINDEX((SELECT Split FROM #temp_Split WHERE ID = @C2), @Contents) <> 0
  					BEGIN
  						INSERT INTO #temp_multiEmails
  						SELECT rid
  							,col AS Content
  						FROM [TCITClient].[dbo].[F_Split_1](@Contents , (SELECT Split FROM #temp_Split WHERE ID = @C2))
  						WHERE ISNULL(col,N'') <> N''
  						ORDER BY rid
  					END
  				--SELECT '#temp_multiEmails before排序',* FROM　#temp_multiEmails
  
  				----SELECT AlignNumber, Content, PATINDEX(CONCAT('%',Content,'%'), (SELECT parametervalue FROM #temp_CompanyParameter where parameterid = 270))
  				--UPDATE a SET a.AlignNumber = PATINDEX(CONCAT('%',Content,'%'), (SELECT parametervalue FROM #temp_CompanyParameter where parameterid = 270))
  				--FROM #temp_multiEmails a
  				--SELECT '#temp_multiEmails after排序',* FROM　#temp_multiEmails
  
  				UPDATE a SET a.Content = @ModifiedEmail
  				FROM #temp_multiEmails a
  				WHERE Content LIKE '%@%'
  
  				UPDATE #temp_CompanyParameter SET ReplacedParameterValue = 
  				(
  					SELECT TOP 1 STUFF(
  											(SELECT 
  													(SELECT Split FROM #temp_Split WHERE ID = @C2) 
  													+ Content 
  											 FROM #temp_multiEmails ORDER BY AlignNumber ASC FOR XML PATH (''))
  										 ,1,1,''
  										 ) AS ParameterValue
  				)
  				FROM #temp_multiEmails
  				WHERE ParameterID = (SELECT ParameterID FROM #temp_CompanyParameter WHERE ID = @C1)
  					AND ReplacedParameterValue IS NULL
  				END
  				--<><><><><><><><><><><><><<><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>
  
  			SET @C2 = 0
  			END
  			--<<<<<<<<<<<<<
  
  			UPDATE #temp_CompanyParameter SET ReplacedParameterValue = @ModifiedEmail
  			FROM #temp_CompanyParameter
  			WHERE ReplacedParameterValue IS NULL
  
  			--SELECT '#temp_CompanyParameter after replacing email', ID, CompanyID, ParameterID, ParameterValue, ReplacedParameterValue FROM #temp_CompanyParameter
  
  			INSERT INTO [TCITClient].[CompanyInfo].[CompanyParameter](CompanyID, ParameterID, ParameterValue, Status, Creator, CreationDate, Modifier, ModifiedDate)
  			SELECT CompanyID, ParameterID, ReplacedParameterValue, Status, Creator, CreationDate, Modifier, ModifiedDate
  			FROM #temp_CompanyParameter	
  
  			IF  OBJECT_ID('tempdb..#temp_Split') IS NOT NULL
  				BEGIN 
  					DROP TABLE  #temp_Split
  				End
  
  			IF OBJECT_ID('tempdb..#temp_CompanyParameter') IS NOT NULL 
  				BEGIN 
  					DROP TABLE  #temp_CompanyParameter
  				End
  
  			IF OBJECT_ID('tempdb..#temp_multiEmails') IS NOT NULL
  				BEGIN 
  					DROP TABLE  #temp_multiEmails
  				End
  
  --<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  
  		INSERT INTO [TCITEAP].[ESOPBasicInfo].[CompanyInfoByESOP] 
  		SELECT @DemoCompanyID [CompanyID]
  			   ,[Brokerage],[CurrencyID],[NeedFollow78],[NeedCashHoldTrade],[NeedConfirmCashHold],[NeedRSUTrade],[NeedCashlessTrade],[NeedDelaySettleRSU]
  			   ,[RSUAutoSellShares],[NeedDelayTaxRefund],[NeedFtpImport],[NeedConfirmExercise],[EnableTrust],[NeedAuditTrust],[SellSharesType]
  			   ,[SellRate],[CashlessRate],[CashlessHoldRate],[CashHoldRate],[RSURESRate],[SubsequentSalesRate],[ExchangeRateType],[ComputedTaxType]
  			   ,[TCITFeeCurrency],[TCITFee],[CashlessTCITFee],[RSUTCITFee],[TrustFee],[FeeExerciseType],[TradeTCITFee],[TaxRefundType],[ListedSite]
  			   ,[ImportTemplate],[Corporation],[CorpAccountNumber],[CorpSymbol]
  			   ,CASE WHEN [BrokerageEmail] = '' THEN '' ELSE @ModifiedEmail END [BrokerageEmail]
  			   ,[RSUServiceName],[ComputedServiceName],[NeedAuditCashless],[TCITCloseTime],[TaxCurrency],[Creator],[CreationDate],[Modifier],[ModifiedDate]
  		FROM [TCITEAP].[ESOPBasicInfo].[CompanyInfoByESOP]
  		WHERE CompanyID	= @TargetCompanyID
  
  		INSERT INTO [TCITEAP].[ESOPBasicInfo].[ExerciserFeeScheme]
  		SELECT @DemoCompanyID [CompanyID]
  			   ,[ExerciseType],[ExerciserFeeSchemeID],[ExerciserFeeSchemeName],[FeeType],[TCSCommissionCode]
  			   ,[Creator],[CreationDate],[OnlineOffline],[SchemeType]
  	    FROM [TCITEAP].[ESOPBasicInfo].[ExerciserFeeScheme]
  		WHERE CompanyID	= @TargetCompanyID
  
  		INSERT INTO [TCITEAP].[ESOPBasicInfo].[ExerciseFeeCode]
  		SELECT @DemoCompanyID [CompanyID]
  			   ,[ExerciseType],[CompanySchemeID],[FeeCode],[ComputeType],[CompareType],[RoundType]
  			   ,[DecimalDigits],[Creator],[CreationDate],[Modifier],[ModifiedDate],[CurrencyID]
  	    FROM [TCITEAP].[ESOPBasicInfo].[ExerciseFeeCode]
  		WHERE CompanyID	= @TargetCompanyID
  
  		INSERT INTO [TCITEAP].[ESOPBasicInfo].[ExerciseFeeCodeDetail]
  		SELECT @DemoCompanyID [CompanyID]
  			   ,[ExerciseType],[CompanySchemeID],[FeeCode],[FeeLevel],[LowerBound],[UpperBound]
  			   ,[FeeRate],[QuickDeduction],[MinFee],[MaxFee],[Creator],[CreationDate],[Modifier],[ModifiedDate]
  		FROM [TCITEAP].[ESOPBasicInfo].[ExerciseFeeCodeDetail]
    		WHERE CompanyID	= @TargetCompanyID
  
  		INSERT INTO [TCITClient].[CompanyInfo].[CompanyReportMapping]
  		SELECT @DemoCompanyID [CompanyID]
  		       ,[ReportTypeID],[Creator],[CreationDate],[Modifier],[ModifiedDate]
  		FROM [TCITClient].[CompanyInfo].[CompanyReportMapping]
    		WHERE CompanyID	= @TargetCompanyID
  	END
  
  IF @ExecuteStep = 5
  	BEGIN
  		SELECT * FROM TCITDATAPROCESSTEMP.DBO.EH20220511_263todemo49_1
  		SELECT * FROM TCITDATAPROCESSTEMP.DBO.EH20220511_263todemo49_2
  		SELECT * FROM TCITDATAPROCESSTEMP.DBO.EH20220511_263todemo49_3
  		SELECT * FROM TCITDATAPROCESSTEMP.DBO.EH20220511_263todemo49_4
  		SELECT * FROM TCITDATAPROCESSTEMP.DBO.EH20220511_263todemo49_5
  		SELECT * FROM TCITDATAPROCESSTEMP.DBO.EH20220511_263todemo49_6
  	END
  ```
-
-